<?xml version="1.0" encoding="UTF-8"?>
<record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <category>custom</category>
        <client_script><![CDATA[function($scope, BDSTEPUtil) {
  /* widget controller */
  var c = this;
	c.data.fileds = [];
	c.data.sites = [];
	
	//ng-disabled="!((form.phd == 'yes' && form.citizen == 'yes') || (form.phd == 'yes' && form.greencard == 'yes'))"
	
	$scope.submitted = false;
	$scope.showError = false;
	$scope.form = {
		phd: '',
		citizen: '',
		greencard: '',
		name: '',
		email:'',
		phone: '',
		mailingAddress: '',
		institution: '', 
		field: '', 
		experience: '',
		firstChoice: '',
		secondChoice: '',
		thirdChoice: '',
		other: ''
	};
	
	loadSiteName();
	loadFieldName();
	
	$scope.displayMessage = function(type){
		if(type == 'phd'){
			$('#info').html("<font size='3'>Please provide your expected PhD graduation date and a short description of the time you plan to spend on BD-STEP research!</font>");
		}else if(type == 'citizen'){
			$('#info').html("<font size='3'>Applicants must be US citizen to be hired within a VA facility. Non-citizens are also encouraged to apply, but are not eligible for VA stipend support!</font>");
		}else {
			$('#info').html("<font size='3' color='red'>You are not qualified to register the Big Data Scientist Training Enhancement Program !</font>");
		}
		$('#infoModal').modal('show');
	}
	$scope.submitForm = function(){
		$scope.submitted = true;
		if(validateInput()){
			$scope.showError = true;
		}else{
			$scope.showError = false;
			var params = JSON.stringify($scope.form);
			BDSTEPUtil.submitApplication($scope.form).then(function(res){
				var id = res.data.result.id.toString();
				uploadFile(id);
			}, function(error){
				alert("ERROR!");
				console.log(error);
			});
		  
		}
	}
	
	function uploadFile(id){
		var file1 = $('#file')[0].files[0];
		var file2 = $('#file1')[0].files[0];
		var file3 = $('#file2')[0].files[0];
		if(!(file1 === undefined)){
			BDSTEPUtil.readFile(file1, handleContents1);
		}
		if(!(file2 === undefined)){
			BDSTEPUtil.readFile(file2, handleContents2);
		}
		if(!(file3 === undefined)){
			BDSTEPUtil.readFile(file3, handleContents3);
		}		
		showMessage();
		//upload file1
	  function handleContents1(contents) {
			var fileName = file1.name;
			console.log(contents);
			BDSTEPUtil.uploadAttachment(id, contents, fileName).then(function(res){
				console.log(res);
			}, function (error){
				alert("ERROR!");
				console.log(error);
			});
		}
		//upload file2
		function handleContents2(contents) {
			var fileName = file2.name;
			BDSTEPUtil.uploadAttachment(id, contents, fileName).then(function(res){
				console.log(res);
			}, function (error){
				alert("ERROR!");
				console.log(error);
			});
		}
		//upload file3
		function handleContents3(contents) {
			var fileName = file3.name;
			BDSTEPUtil.uploadAttachment(id, contents, fileName).then(function(res){
				console.log(res);
			}, function (error){
				alert("ERROR!");
				console.log(error);
			});
		}		
	}
	
	function showMessage(){
		$('#info').html("<font color='green'>Your application has been submitted successfully.</font>");
		$('#infoModal').modal('show');
		$scope.form.phd = '';
		$scope.form.citizen = '';
		$scope.form.greencard = '';
		$scope.form.name = '';
		$scope.form.email = '';
		$scope.form.phone = '';
		$scope.form.mailingAddress = '';
		$scope.form.institution = ''; 
		$scope.form.field = ''; 
		$scope.form.experience = '';
		$scope.form.firstChoice = '';
		$scope.form.secondChoice = '';
		$scope.form.thirdChoice = '';
		$scope.form.other = '';
		$scope.submitted = false;
	  $scope.showError = false;
	}
	//return true shows there is an error
	function validateInput(){
		var file1 = $('#file')[0].files[0];
		var file2 = $('#file1')[0].files[0];
		var file3 = $('#file2')[0].files[0];
    cleanBgColor();
		if($scope.form.phd.trim().length == 0 || $scope.form.name.trim().length == 0 || $scope.form.phone.trim().length == 0 || $scope.form.mailingAddress.trim().length == 0 ||
			 $scope.form.citizen.trim().length == 0 || $scope.form.institution.trim().length == 0 || $scope.form.field.trim().length == 0 || $scope.form.experience.trim().length == 0 ||
			 $scope.form.firstChoice.trim().length == 0 || file1 === undefined || file2 === undefined || file3 === undefined){
			 if(file1 === undefined){
				 $('#certificate_label').css('background-color', 'yellow');
			 }
			 if(file2 === undefined){
				 $('#certificate_label1').css('background-color', 'yellow');
			 }
			 if(file3 === undefined){
				 $('#certificate_label2').css('background-color', 'yellow');
			 }
			if($scope.form.phd.trim().length == 0){
				$('#phdLabel').css('background-color', 'yellow');
			}
			if($scope.form.citizen.trim().length == 0){
				$('#citizenLabel').css('background-color', 'yellow');
			}
			
			 return true;
		}else{
			return false;
		}
	}
	function cleanBgColor(){
		 $('#certificate_label').css('background-color', '');
		 $('#certificate_label1').css('background-color', '');
		 $('#certificate_label2').css('background-color', '');
		 $('#phdLabel').css('background-color', '');
		 $('#citizenLabel').css('background-color', '');
		 $('#certificate_label').html('<span style="color: #716f6f;font-weight: normal;margin-left: 10px;">Select Curriculum Vitae file to be uploaded</span>');
		 $('#certificate_label1').html('<span style="color: #716f6f;font-weight: normal;margin-left: 10px;">Select Personal Statement file to be uploaded</span>');
		 $('#certificate_label2').html('<span style="color: #716f6f;font-weight: normal;margin-left: 10px;">Select Letter of support from Supervisor file to be uploaded</span>');
	}
	function loadFieldName(){
		BDSTEPUtil.getFieldName().then(function(res){
			c.data.fields = res.data.result;
		}, function(error){
			alert('ERROR!');
			console.log(error);
		});
	}
	function loadSiteName(){
		BDSTEPUtil.getSiteName().then(function(res){
			c.data.sites = res.data.result;
		}, function(error){
			alert("ERROR!");
			console.log(error);
		});
	}
	var limitWord = 300;
	$("#experience").keyup(function () {
			$this = $(this);
			var regex = /\s+/gi;
			var wordcount = jQuery.trim($this.val()).replace(regex, ' ').split(' ').length;
			if (wordcount <= limitWord) {
					chars = $this.val().length;
			} else {
					var text = $(this).val();
					var new_text = text.substr(0, chars);
					$(this).val(new_text);
					wordcount --;
			}
			$("#count-label").html(wordcount);
	});
	
		var fileInput  = document.querySelector( ".input-file" ),  
			button     = document.querySelector( ".input-file-trigger" ),
			fileDisplay     = $("#certificate_label");
	  
		fileInput.addEventListener( "change", function( event ) {
			c.data.inputFile1 = this.value;
			fileDisplay.html(this.value);
			$scope.$apply();
		});  
	
		var fileInput1  = document.querySelector( ".input-file1" ),  
			button1     = document.querySelector( ".input-file-trigger1" ),
			fileDisplay1     = $("#certificate_label1");
	  
		fileInput1.addEventListener( "change", function( event ) {
			c.data.inputFile2 = this.value;
			fileDisplay1.html(this.value);
			$scope.$apply();
		});  
	
		var fileInput2  = document.querySelector( ".input-file2" ),  
			button2     = document.querySelector( ".input-file-trigger2" ),
			fileDisplay2     = $("#certificate_label2");
	  
		fileInput2.addEventListener( "change", function( event ) {
			c.data.inputFile3 = this.value;
			fileDisplay2.html(this.value);
			$scope.$apply();
		}); 
}

]]></client_script>
        <controller_as>c</controller_as>
        <css>.file-section{
  width:100%;
}
.input-file-container {
  display:inline-block;
  position: relative;
  
} 
.input-file-trigger {
  display: block;
  padding: 10px 25px;
  background:#0280a9;
  color: #fff;
}
.input-file {
  position: absolute;
  display：block;
  top: 0; left: 0;
  height:40px;
  opacity: 0;
  cursor:pointer;
  text-indent: -999px;
}

.file-return {
  border: 1px solid #ccc;
  border-top-left-radius: 4px;
  border-bottom-left-radius: 4px;
  width: calc(100% - 105px);
  height: 40px;
  line-height:40px;
  display: inline-block;
  font-style: italic;
  font-size: .9em;
  font-weight: bold;
  float:left;
  text-overflow: ellipsis;
  white-space: nowrap;
  overflow: hidden;
}

.input-file1 {
  position: absolute;
  display：block;
  top: 0; left: 0;
  height:40px;
  opacity: 0;
  cursor:pointer;
  text-indent: -999px;
}
.input-file-trigger1 {
  display: block;
  padding: 10px 25px;
  background:#0280a9;
  color: #fff;
}
.input-file2 {
  position: absolute;
  display：block;
  top: 0; left: 0;
  height:40px;
  opacity: 0;
  cursor:pointer;
  text-indent: -999px;
}
.input-file-trigger2 {
  display: block;
  padding: 10px 25px;
  background:#0280a9;
  color: #fff;
}

.bg-yellow {
  background-color: yellow;
}
.mid-font-size {
  font-size: medium;
}</css>
        <data_table>sp_instance</data_table>
        <demo_data/>
        <description/>
        <docs/>
        <field_list/>
        <has_preview>false</has_preview>
        <id>bd_step_registration</id>
        <internal>false</internal>
        <link/>
        <name>BD STEP Registration</name>
        <option_schema/>
        <public>true</public>
        <roles/>
        <script><![CDATA[(function() {

})();]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>zhoujim@nih.gov</sys_created_by>
        <sys_created_on>2019-01-03 22:00:32</sys_created_on>
        <sys_customer_update>false</sys_customer_update>
        <sys_id>28f63e99db76af40b86770c08c961979</sys_id>
        <sys_mod_count>505</sys_mod_count>
        <sys_name>BD STEP Registration</sys_name>
        <sys_package display_value="BD STEP" source="x_naci_bd_step">12dec3d8dbba2f4054d8ff621f961941</sys_package>
        <sys_policy/>
        <sys_replace_on_upgrade>false</sys_replace_on_upgrade>
        <sys_scope display_value="BD STEP">12dec3d8dbba2f4054d8ff621f961941</sys_scope>
        <sys_update_name>sp_widget_28f63e99db76af40b86770c08c961979</sys_update_name>
        <sys_updated_by>zhoujim@nih.gov</sys_updated_by>
        <sys_updated_on>2019-01-16 14:52:07</sys_updated_on>
        <template><![CDATA[<form name="inputForm" ng-submit="submitForm()" novalidate>
  <br/><br/>
  <div class="row" align="center"><label><font size="5" color="red">Big Data Scientist Training Enhancement Program (BD-STEP) - Registration</font></label></div>
  <br/>
  <div class="row"  ng-show="showError == true">
    <div class="col-md-10" style="margin-left: 20px; margin-bottom:20px;"><font color='red'>Please fill in required fields.</font></div>>
  </div>
  
  <div class="row">
    <div class="col-md-3">
      <label style="margin-left: 30px;" id='phdLabel'><b>Not a Ph.D.?</b></label>
    </div>
    <div class="col-md-1">
      <input type="radio" name="phd" value="yes" ng-model="form.phd" />&nbsp;Yes
    </div>
    <div class="col-md-1">
      <input type="radio" name="phd" value="no" ng-model="form.phd" ng-click="displayMessage('phd');"/>&nbsp;No
    </div>
  </div>
  <div class="row">
    <div class="col-md-3">
      <label style="margin-left: 30px; margin-top: 5px;" id='citizenLabel'><b>Not a Citizen?</b></label>
    </div>
    <div class="col-md-1">
      <input type="radio" name="citizen" value="yes" ng-model="form.citizen"/>&nbsp;Yes
    </div>
    <div class="col-md-1">
      <input type="radio" name="citizen" value="no" ng-model="form.citizen" ng-click="displayMessage('citizen');"/>&nbsp;No
    </div>
  </div>  
  <div class="row">
    <div class="col-md -12 panel panel-default" style="margin-top: 10px; margin-left: 40px; margin-right:40px;">
      <div class="panel-heading"><b>Your information</b></div>
      <div class="panel-body panel-bgColor">
        <div class="row">
          <div class="col-md-6">
            <div class="row">
              <div class="col-xm-10 form-margin-right" >
                <label for="name" style="margin-left: 10px;"> <b><font color='red'>*</font>Name (Last Name, First, Middle Initial)</b></label>
              </div>
              <div class="col-xm-10 form-margin-right" >
                <input 
                       class="form-control" 
                       ng-class="{'bg-yellow': submitted && inputForm.name.$error.required}"
                       style="margin-left: 10px;" 
                       required
                       type="text" 
                       name="name" 
                       ng-model="form.name"/>

              </div>
            </div>   
            <div class="row">
              <div class="col-xm-10 form-margin-right" style="margin-top:10px;">
                <label for="email" style="margin-left: 10px;"> <b><font color='red'>*</font>Email Address</b></label>
              </div>
              <div class="col-xm-10 form-margin-right">
                <input class="form-control"  required ng-class="{'bg-yellow': submitted && inputForm.email.$error.required}" style="margin-left: 10px;" type="text" name="email" ng-model="form.email" />
              </div>
            </div>
            <div class="row">
              <div class="col-xm-10 form-margin-right" style="margin-top:10px;">
                <label for="phone" style="margin-left: 10px;"><b> <font color='red'>*</font>Work Telephone Number</b></label>
              </div>
              <div class="col-xm-10 form-margin-right">
                <input class="form-control"  required ng-class="{'bg-yellow': submitted && inputForm.phone.$error.required}" style="margin-left: 10px;" type="text" name="phone" ng-model="form.phone" />
              </div>
            </div>
            <div class="row">
              <div class="col-xm-10 form-margin-right" style="margin-top:10px;">
                <label for="mailingAddress" style="margin-left: 10px;"><b> <font color='red'>*</font>Mailing Address</b></label>
              </div>
              <div class="col-xm-10 form-margin-right">
                <textarea class="form-control" required ng-class="{'bg-yellow': submitted && inputForm.mailingAddress.$error.required}" style="margin-left: 10px;" rows="4" name="mailingAddress" ng-model="form.mailingAddress"></textarea>
              </div>
            </div>
            <div class="row">
              <div class="col-xm-10 form-margin-right" style="margin-top:10px;">
                <label for="institution" style="margin-left: 10px;"> <b><font color='red'>*</font>Affiliated Institution</b></label>
              </div>
              <div class="col-xm-10 form-margin-right">
                <input class="form-control"  required ng-class="{'bg-yellow': submitted && inputForm.institution.$error.required}" style="margin-left: 10px;" type="text" name="institution" ng-model="form.institution" />
              </div>
            </div>
            <div class="row">
              <div class="col-xm-10 form-margin-right" style="margin-top:10px;">
                <label for="field" style="margin-left: 10px;"> <b><font color='red'>*</font>Field of Study for Ph.D.</b></label>
              </div>
            </div>
            <div class="row">
              <div class="col-md-7">
                <select class="form-control"   required ng-class="{'bg-yellow': submitted && inputForm.field.$error.required}" style="margin-left: 1px;" name="field" ng-model="form.field">
                  <option value="">Please select a field of study for Ph.D.</option>
                  <option ng-repeat="x in c.data.fields" value="{{x.value}}">{{x.label}}</option>
                </select>
              </div>
              <div class="col-md-5" ng-show="form.field == 'Other'">
                <input type="text" class="form-control" ng-model="form.other" placeholder="Enter a field of study"/>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="row">
              <div class="col-xm-10 form-margin-left form-margin-right">
                <label for="experience"> <b><font color='red'>*</font>Experience in bioinformatics, modeling, management of large datasets(300 words)</b></label>
              </div>
              <div class="col-xm-10 form-margin-left form-margin-right">
                <textarea class="form-control"  required ng-class="{'bg-yellow': submitted && inputForm.experience.$error.required}" rows="21" id="experience" name="experience" ng-model="form.experience" ></textarea>
                Word count: <label id="count-label">0</label>
              </div>
            </div>           
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <div class="col-md-6">
            <div>
              <label><b><font color='red'>*</font>Upload Curriculum Vitae(CV), Personal Statement, and Letter of Support from Supervisor&nbsp;</b><img src="contextual_help.png" width="20px" height="20px" Alt="Help" Title="Brief statement of interest (maximum one page) to include proposed research areas/topics letter of support from acadamic mentor for postdoctoral research (existing or planned research relationship)"/></label>      
            </div>
            <div class="form-section" style="margin-top:5px;">
              <div class="file-section">
                <div class="file-return" id="certificate_label">
                  <span style="color: #716f6f;font-weight: normal;margin-left: 10px;">Select Curriculum Vitae file to be uploaded</span>
                </div>
                <div class="input-file-container">
                  <input class="input-file" id="file" type="file" accept=".doc, .docx, .pdf">
                  <label for="file" class="input-file-trigger">Browse...</label>
                </div>
              </div> 
            </div>
            <div class="form-section" style="margin-top:5px">
              <div class="file-section">
                <div class="file-return" id="certificate_label1">
                  <span style="color: #716f6f;font-weight: normal;margin-left: 10px;">Select Personal Statement file to be uploaded</span>
                </div>
                <div class="input-file-container">
                  <input class="input-file1" id="file1" type="file" accept=".doc, .docx, .pdf">
                  <label for="file1" class="input-file-trigger1">Browse...</label>
                </div>
              </div> 
            </div>
            <div class="form-section" style="margin-top:5px">
              <div class="file-section">
                <div class="file-return" id="certificate_label2">
                  <span style="color: #716f6f;font-weight: normal;margin-left: 10px;">Select Letter of support from Supervisor file to be uploaded</span>
                </div>
                <div class="input-file-container">
                  <input class="input-file2" id="file2" type="file" accept=".doc, .docx, .pdf">
                  <label for="file2" class="input-file-trigger2">Browse...</label>
                </div>
              </div> 
            </div>            
          </div>
          <div class="col-md-6">
            <div class="row">
              <div class="col-xm-12 form-margin-left" >
                <lable><b>Please choose at least one of the BD-STEP VA medical center locations, with your first choice at the top. If you are only interested in matching with one VA site, list only one option.</b></lable>  
              </div>
            </div>
            <div class="col-xm-12">
              <div class="col-md-6">
                <label><b><font color='red'>*</font>1st Choice</b></label>
              </div>
              <div class="col-md-6" >
                <select class="form-control" required name="firstChoice" ng-class="{'bg-yellow': submitted && inputForm.firstChoice.$error.required}" ng-model="form.firstChoice">
                  <option value="">Please select a site</option>
                  <option ng-repeat="x in c.data.sites" value="{{x.value}}">{{x.label}}</option>
                </select>
              </div>
            </div>
            <div class="col-xm-12">
              <div class="col-md-6">
                <label><b>2nd Choice</b></label>
              </div>
              <div class="col-md-6" style="margin-top:10px;">
                <select class="form-control" ng-model="form.secondChoice">
                  <option value="">Please select a site</option>
                  <option ng-repeat="x in c.data.sites" value="{{x.value}}">{{x.label}}</option>
                </select>
              </div>
            </div>
            <div class="col-xm-12">
              <div class="col-md-6">
                <label><b>3rd Choice</b></label>
              </div>
              <div class="col-md-6" style="margin-top:10px;">
                <select class="form-control" ng-model="form.thirdChoice">
                  <option value="">Please select a site</option>
                  <option ng-repeat="x in c.data.sites" value="{{x.value}}">{{x.label}}</option>
                </select>
              </div>
            </div>              

          </div>
        </div>
      </div>
    </div>
    <div class="row" style="margin-top:10px; margin-bottom: 20px;">
      <div class="col-md-12" align="center">
        <button type="submit" class="btn btn-primary" style="width:120px">
          Submit
        </button>
      </div>  
    </div> 
  </div>
  <div id="infoModal" class="modal fade">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
          <h4 id="lblTitleConfirmOk" class="modal-title">Information</h4>
        </div>
        <div class="modal-body">
          <span id="info"></span>
        </div>
        <div class="modal-footer">
          <button id="btnOkConfirm" type="button" class="btn btn-primary" style="width: 70px; text-align: center;" data-dismiss="modal" aria-label="Close">OK</button>
        </div>
      </div>
    </div>
  </div>
</form>]]></template>
    </sp_widget>
</record_update>
